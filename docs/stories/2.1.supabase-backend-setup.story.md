# Story 2.1: Supabase Backend Setup

## Status
Ready

## Story
**As a** developer,
**I want** to set up the **mcp supabase** project and define the database schema for leads,
**so that** I have a secure and structured backend ready to receive data.

## Acceptance Criteria
1. The **mcp supabase** project is provisioned with proper configuration.
2. A "leads" table is created with columns for name, location, WhatsApp number, service, timestamp, and payment status.
3. Row Level Security (RLS) is enabled with appropriate policies.
4. Supabase credentials are stored as environment variables in the Next.js project.
5. Database schema is properly documented and version controlled.
6. Basic API connectivity is tested and verified.

## Tasks / Subtasks
- [ ] Task 1 (AC: 1)
  - [ ] Provision new Supabase project using mcp supabase tools
  - [ ] Configure project settings (region, database settings)
  - [ ] Verify project is accessible and operational
  - [ ] Document project configuration details
- [ ] Task 2 (AC: 2)
  - [ ] Create leads table with proper column definitions
  - [ ] Set up appropriate data types and constraints
  - [ ] Add indexes for performance optimization
  - [ ] Implement proper foreign key relationships if needed
- [ ] Task 3 (AC: 3)
  - [ ] Enable Row Level Security (RLS) on leads table
  - [ ] Create RLS policies for data access control
  - [ ] Test RLS policies with different access scenarios
  - [ ] Document security policies and access patterns
- [ ] Task 4 (AC: 4)
  - [ ] Create .env.local file with Supabase credentials
  - [ ] Add environment variables to .env.example
  - [ ] Configure Next.js to use environment variables
  - [ ] Verify credentials are properly loaded
- [ ] Task 5 (AC: 5, 6)
  - [ ] Create database schema documentation
  - [ ] Set up migration files for version control
  - [ ] Test basic CRUD operations on leads table
  - [ ] Verify API connectivity from Next.js application

## Dev Notes

### Previous Story Insights
- Next.js 15 project is successfully set up with TypeScript and App Router
- Tailwind CSS v4 is configured with shadcn/ui components
- Homepage is complete with all 5 sections and responsive design
- Project structure follows architecture specifications with proper folder organization
- Header and navigation are properly placed in layout.tsx for cross-page consistency
[Source: docs/stories/1.2.homepage-construction.story.md]

### Data Models
**Leads Table Schema:**
```sql
CREATE TABLE leads (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  location VARCHAR(255) NOT NULL,
  whatsapp_number VARCHAR(20) NOT NULL,
  service VARCHAR(100) NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  payment_status VARCHAR(50) DEFAULT 'pending',
  payment_amount DECIMAL(10,2),
  payment_reference VARCHAR(255),
  status VARCHAR(50) DEFAULT 'new',
  notes TEXT
);
```

### API Specifications
- **Supabase Client Setup**: Use @supabase/supabase-js for client-side operations
- **Server-Side Client**: Create src/lib/supabase-server.ts for server-side operations
- **Environment Variables**: NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY
- **API Routes**: Will be implemented in subsequent stories (src/app/api/leads/route.ts)

### Component Specifications
- No UI components required for this backend setup story
- Focus on infrastructure and configuration
- Create utility functions in src/lib/supabase-client.ts and src/lib/supabase-server.ts
- Follow TypeScript interfaces for lead data types in src/types/lead.ts
[Source: docs/architecture/05-4-component-standards.md]

### File Locations
- Environment variables: .env.local, .env.example
- Supabase client: src/lib/supabase-client.ts (client-side)
- Supabase server: src/lib/supabase-server.ts (server-side)
- Lead types: src/types/lead.ts
- Database schema: docs/database/schema.sql
- Migration files: docs/database/migrations/
[Source: docs/architecture/04-3-project-structure.md]

### Testing Requirements
- Test file location: src/lib/__tests__/ (for utility functions)
- Test standards: Jest & React Testing Library
- Testing frameworks: Jest for unit testing
- Specific testing requirements: Test Supabase connection, environment variable loading, basic CRUD operations
[Source: docs/architecture/03-2-frontend-tech-stack.md]

### Technical Constraints
- Next.js 15 (React) with App Router
- TypeScript for type safety
- Supabase as backend-as-a-service
- Row Level Security (RLS) for data protection
- Environment variable management for credentials
- Database migrations for schema version control
[Source: docs/architecture/03-2-frontend-tech-stack.md]

### Security Requirements
- Row Level Security (RLS) enabled on all tables
- Proper access policies for different user roles
- Environment variables for sensitive credentials
- Input validation and sanitization (will be implemented in form stories)
- Secure API endpoints with proper authentication

### Database Design Considerations
- Use UUID for primary keys for security
- Include audit fields (created_at, updated_at)
- Proper indexing for performance
- Foreign key relationships if needed for future expansion
- Payment status tracking for Razorpay integration
- Status field for lead lifecycle management

### Testing
- Test file location: src/lib/__tests__/
- Test standards: Jest & React Testing Library
- Testing frameworks: Jest for unit testing
- Specific testing requirements: Verify Supabase connection, test environment variables, validate schema creation, test RLS policies

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

### Agent Model Used
*To be filled by development agent*

### Debug Log References
*To be filled by development agent*

### Completion Notes List
*To be filled by development agent*

### File List
*To be filled by development agent*

## QA Results 
*To be filled by QA agent* 